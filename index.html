<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strategic Chess Auditor v2.5 - Max 4 Lines</title>
    
    <!-- Professional Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary-dark: #0f172a;
            --accent-green: #22c55e;
            --accent-blue: #4f46e5;
            --accent-orange: #f59e0b;
        }

        html, body { 
            background: #f1f5f9;
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .main-wrapper {
            display: flex; flex-direction: column;
            align-items: center; padding: 1rem;
            min-height: 100%; overflow-y: auto;
        }
        
        .board-container {
            position: relative; width: 100%;
            max-width: 400px; aspect-ratio: 1 / 1;
            margin: 0 auto; border: 6px solid #fff;
            border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            touch-action: none; 
        }

        #myBoard { width: 100% !important; height: 100% !important; }

        #drawingCanvas {
            position: absolute; top: 0; left: 0;
            pointer-events: none; z-index: 50;
        }

        .control-label {
            font-size: 10px; font-weight: 800;
            color: #64748b; text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-action { transition: all 0.2s ease; }
        .btn-action:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="w-full max-w-md bg-white p-6 rounded-[2.5rem] shadow-2xl mt-2 mb-8">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-black text-slate-800 italic uppercase">Auditor <span class="text-green-500">v2.5</span></h1>
                <div id="engineStatus" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-400 border border-slate-200 uppercase">
                    Offline
                </div>
            </div>

            <!-- Board Wrapper -->
            <div class="board-container" id="boardWrapper">
                <div id="myBoard"></div>
                <canvas id="drawingCanvas"></canvas>
            </div>

            <!-- Real-time Eval -->
            <div id="gameStatus" class="mt-4 text-center py-2 bg-slate-800 rounded-xl text-white text-[10px] font-bold uppercase tracking-widest">
                Sinkronisasi Engine Aktif
            </div>

            <!-- PRIMARY ACTIONS -->
            <div class="mt-4 grid grid-cols-2 gap-3">
                <button onclick="flipBoard()" class="bg-indigo-600 btn-action py-4 rounded-2xl text-[10px] font-black text-white uppercase tracking-widest shadow-lg shadow-indigo-100">
                    üîÑ Balik Papan
                </button>
                <button onclick="undoMove()" class="bg-orange-500 btn-action py-4 rounded-2xl text-[10px] font-black text-white uppercase tracking-widest shadow-lg shadow-orange-100">
                    ‚¨ÖÔ∏è Undo Move
                </button>
            </div>

            <!-- Controls Panel -->
            <div class="mt-4 space-y-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <label class="control-label block mb-1">Set Elo (Rating) (Max = 3000)</label>
                        <input type="number" id="eloInput" value="1500" min="800" max="3000" class="w-24 p-2 rounded-lg font-mono font-bold text-slate-700 text-sm border border-slate-200 outline-none focus:border-green-500">
                    </div>
                    <div class="text-right text-[10px] font-bold text-slate-400">
                        DEPTH: 12
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="control-label">Multi-PV (Jalur)</label>
                        <span id="pvVal" class="text-[10px] font-bold text-green-600">4 Jalur</span>
                    </div>
                    <!-- Max diubah menjadi 4 sesuai permintaan -->
                    <input type="range" id="pvInput" min="1" max="4" value="4" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-500">
                </div>
            </div>

            <!-- Reset Button -->
            <div class="mt-4">
                <button onclick="resetGame()" class="w-full bg-red-100 text-red-600 border border-red-200 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-all">
                    Reset Posisi Game
                </button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        var board = null;
        var game = new Chess();
        var stockfish = null;
        var engineUrl = "https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js";
        var currentMoves = [];
        const FIXED_DEPTH = 12;
        var debounceTimer;

        // Mencegah scrolling browser saat interaksi papan
        document.getElementById('boardWrapper').addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        function initStockfish() {
            try {
                const blobCode = `importScripts("${engineUrl}");`;
                const blobUrl = URL.createObjectURL(new Blob([blobCode], { type: 'application/javascript' }));
                stockfish = new Worker(blobUrl);
                
                stockfish.postMessage("uci");
                
                stockfish.onmessage = function(e) {
                    const line = e.data;
                    
                    if (line.includes('info depth') && line.includes('multipv')) {
                        const pvMatch = line.match(/multipv\s(\d+)/);
                        const moveMatch = line.match(/pv\s([a-h][1-8][a-h][1-8])/);
                        if (pvMatch && moveMatch) {
                            const pvIndex = parseInt(pvMatch[1]);
                            const moveStr = moveMatch[1];
                            currentMoves[pvIndex - 1] = { move: moveStr };
                        }
                    }
                    
                    if (line.includes('bestmove')) { 
                        renderArrows(); 
                    }
                };
                
                $('#engineStatus').text('Engine Active').addClass('text-green-500 bg-green-50');
                updateEngineSettings();
            } catch (err) {
                $('#engineStatus').text('Engine Error').addClass('text-red-500');
            }
        }

        function eloToSkill(elo) {
            let skill = Math.round((elo - 800) / 110);
            return Math.min(20, Math.max(0, skill));
        }

        function updateEngineSettings() {
            if (!stockfish) return;
            const elo = parseInt($('#eloInput').val()) || 1500;
            const skill = eloToSkill(elo);
            const pv = $('#pvInput').val();
            
            // Mengirim sinyal reset untuk sinkronisasi Multi-PV yang bersih
            stockfish.postMessage("stop");
            stockfish.postMessage("isready");
            stockfish.postMessage("ucinewgame");
            stockfish.postMessage("setoption name Skill Level value " + skill);
            stockfish.postMessage("setoption name MultiPV value " + pv);
            
            requestAnalysis();
        }

        function requestAnalysis() {
            if (!stockfish || game.game_over()) return;
            currentMoves = []; 
            clearCanvas();
            stockfish.postMessage("position fen " + game.fen());
            stockfish.postMessage("go depth " + FIXED_DEPTH);
        }

        function renderArrows() {
            clearCanvas();
            const canvas = document.getElementById('drawingCanvas');
            const boardEl = $('#myBoard');
            if (!boardEl.width()) return;

            canvas.width = boardEl.width();
            canvas.height = boardEl.height();
            const ctx = canvas.getContext('2d');
            const sq = canvas.width / 8;

            function getC(s) {
                let c = s.charCodeAt(0) - 97;
                let r = 8 - parseInt(s[1]);
                if (board.orientation() === 'black') { 
                    c = 7 - c; r = 7 - r; 
                }
                return { x: (c * sq) + sq/2, y: (r * sq) + sq/2 };
            }

            currentMoves.forEach((data, index) => {
                if (!data || !data.move) return;
                // Gradasi transparansi untuk membedakan urutan prioritas
                const alpha = 0.9 * Math.pow(0.7, index); 
                const color = `rgba(34, 197, 94, ${alpha})`;
                const from = data.move.substring(0, 2);
                const to = data.move.substring(2, 4);
                const s = getC(from), e = getC(to);
                
                ctx.strokeStyle = color;
                ctx.lineWidth = Math.max(2, 6 - index); 
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(s.x, s.y);
                ctx.lineTo(e.x, e.y);
                ctx.stroke();

                const angle = Math.atan2(e.y - s.y, e.x - s.x);
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(e.x, e.y);
                ctx.lineTo(e.x - 12 * Math.cos(angle - Math.PI/6), e.y - 12 * Math.sin(angle - Math.PI/6));
                ctx.lineTo(e.x - 12 * Math.cos(angle + Math.PI/6), e.y - 12 * Math.sin(angle + Math.PI/6));
                ctx.fill();
            });
        }

        function clearCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function onDrop(source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus();
            clearCanvas();
            setTimeout(requestAnalysis, 100);
        }

        function updateStatus() {
            let s = game.turn() === 'w' ? 'Giliran Putih' : 'Giliran Hitam';
            if (game.in_checkmate()) s = 'SKAKMAT!';
            else if (game.in_draw()) s = 'REMIS';
            $('#gameStatus').text(s);
        }

        function flipBoard() { 
            board.flip(); 
            renderArrows(); 
        }

        function undoMove() {
            game.undo();
            board.position(game.fen());
            updateStatus();
            if(stockfish) {
                stockfish.postMessage("stop");
                requestAnalysis();
            }
        }

        function resetGame() { 
            game.reset(); 
            board.start(); 
            updateStatus(); 
            requestAnalysis(); 
        }

        // Penanganan slider dengan sistem jeda (Debounce)
        $('#pvInput').on('input', function() { 
            const val = $(this).val();
            $('#pvVal').text(val + " Jalur"); 
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateEngineSettings();
            }, 300); 
        });
        
        $('#eloInput').on('change', function() {
            updateEngineSettings();
        });

        $(document).ready(function() {
            board = Chessboard('myBoard', {
                draggable: true,
                position: 'start',
                onDrop: onDrop,
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
            updateStatus();
            initStockfish();
        });
    </script>
</body>
</html>
