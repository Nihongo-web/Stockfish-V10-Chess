<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strategic Chess Auditor v2.6 - PV Optimized</title>
    
    <!-- Professional Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary-dark: #0f172a;
            --accent-green: #22c55e;
            --accent-blue: #4f46e5;
            --accent-orange: #f59e0b;
        }

        html, body { 
            background: #f1f5f9;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            min-height: 100%;
            overflow-y: auto;
        }
        
        .board-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            margin: 0 auto;
            border: 6px solid #fff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            touch-action: none; 
        }

        #myBoard { width: 100% !important; height: 100% !important; }

        #drawingCanvas {
            position: absolute;
            top: 0; left: 0;
            pointer-events: none;
            z-index: 50;
        }

        .control-label {
            font-size: 10px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-action:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="w-full max-w-md bg-white p-6 rounded-[2.5rem] shadow-2xl mt-2 mb-8">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex flex-col">
                    <h1 class="text-xl font-black text-slate-800 italic uppercase leading-none">Auditor <span class="text-green-500">v2.6</span></h1>
                    <span class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter">Optimized Analysis Mode</span>
                </div>
                <div id="engineStatus" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-400 border border-slate-200 uppercase">
                    Offline
                </div>
            </div>

            <!-- Board Wrapper -->
            <div class="board-container" id="boardWrapper">
                <div id="myBoard"></div>
                <canvas id="drawingCanvas"></canvas>
            </div>

            <!-- Real-time Eval -->
            <div id="gameStatus" class="mt-4 text-center py-2 bg-slate-800 rounded-xl text-white text-[10px] font-bold uppercase tracking-widest">
                Siap Beroperasi
            </div>

            <!-- PRIMARY ACTIONS -->
            <div class="mt-4 grid grid-cols-2 gap-3">
                <button onclick="flipBoard()" class="bg-indigo-600 text-white btn-action py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg">
                    üîÑ Balik Papan
                </button>
                <button onclick="undoMove()" class="bg-amber-500 text-white btn-action py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg">
                    ‚¨ÖÔ∏è Undo Move
                </button>
            </div>

            <!-- Controls Panel -->
            <div class="mt-4 space-y-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <label class="control-label block mb-1">Set Elo (Rating)</label>
                        <input type="number" id="eloInput" value="1500" min="800" max="3000" class="w-24 p-2 rounded-lg font-mono font-bold text-slate-700 text-sm border border-slate-200 outline-none">
                    </div>
                    <div class="text-right">
                        <span class="text-[9px] font-black text-green-600 bg-green-100 px-2 py-1 rounded">FAST RESPONSE</span>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="control-label">Analisis Multi-PV</label>
                        <span id="pvVal" class="text-[10px] font-bold text-green-600">4 Lines</span>
                    </div>
                    <!-- PV dibatasi maksimal 4 sesuai permintaan -->
                    <input type="range" id="pvInput" min="1" max="4" value="4" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-500">
                </div>
            </div>

            <!-- Reset Button -->
            <div class="mt-4">
                <button onclick="resetGame()" class="w-full bg-red-100 text-red-600 border border-red-200 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-all">
                    Reset Posisi Game
                </button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        var board = null;
        var game = new Chess();
        var stockfish = null;
        var engineUrl = "https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js";
        var currentMoves = [];
        
        // Optimasi Blitz: Depth 10 untuk respon instan
        const BLITZ_DEPTH = 10; 

        document.getElementById('boardWrapper').addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        function initStockfish() {
            try {
                const blobCode = `importScripts("${engineUrl}");`;
                const blobUrl = URL.createObjectURL(new Blob([blobCode], { type: 'application/javascript' }));
                stockfish = new Worker(blobUrl);
                
                stockfish.onmessage = function(e) {
                    const line = e.data;
                    
                    // Feedback Real-time untuk panah
                    if (line.includes('info depth') && line.includes('multipv')) {
                        const pvMatch = line.match(/multipv\s(\d+)/);
                        const moveMatch = line.match(/pv\s([a-h][1-8][a-h][1-8])/);
                        if (pvMatch && moveMatch) {
                            const pvIndex = parseInt(pvMatch[1]);
                            const moveStr = moveMatch[1];
                            currentMoves[pvIndex - 1] = { move: moveStr };
                            renderArrows(); 
                        }
                    }
                };
                
                stockfish.postMessage("uci");
                stockfish.postMessage("isready");
                $('#engineStatus').text('Turbo v2.6 Active').addClass('text-green-500 bg-green-50');
                updateEngineSettings();
                requestAnalysis();
            } catch (err) {
                $('#engineStatus').text('Engine Error').addClass('text-red-500');
            }
        }

        function eloToSkill(elo) {
            let skill = Math.round((elo - 800) / 110);
            return Math.min(20, Math.max(0, skill));
        }

        function updateEngineSettings() {
            if (!stockfish) return;
            const elo = parseInt($('#eloInput').val()) || 1500;
            const skill = eloToSkill(elo);
            const pv = $('#pvInput').val();
            stockfish.postMessage("setoption name Skill Level value " + skill);
            stockfish.postMessage("setoption name MultiPV value " + pv);
            stockfish.postMessage("setoption name Hash value 32"); 
        }

        function requestAnalysis() {
            if (!stockfish || game.game_over()) return;
            currentMoves = [];
            stockfish.postMessage("stop");
            stockfish.postMessage("ucinewgame");
            stockfish.postMessage("position fen " + game.fen());
            stockfish.postMessage("go depth " + BLITZ_DEPTH);
        }

        function renderArrows() {
            const canvas = document.getElementById('drawingCanvas');
            const boardEl = $('#myBoard');
            if (canvas.width !== boardEl.width()) {
                canvas.width = boardEl.width();
                canvas.height = boardEl.height();
            }
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const sq = canvas.width / 8;

            function getC(s) {
                let c = s.charCodeAt(0) - 97;
                let r = 8 - parseInt(s[1]);
                if (board.orientation() === 'black') { 
                    c = 7 - c; r = 7 - r; 
                }
                return { x: (c * sq) + sq/2, y: (r * sq) + sq/2 };
            }

            currentMoves.forEach((data, index) => {
                if (!data) return;
                const alpha = Math.max(0.2, 0.9 * Math.pow(0.7, index));
                const color = `rgba(34, 197, 94, ${alpha})`;
                const s = getC(data.move.substring(0, 2)), e = getC(data.move.substring(2, 4));
                
                ctx.strokeStyle = color;
                ctx.lineWidth = Math.max(2, 5 - index);
                ctx.beginPath();
                ctx.moveTo(s.x, s.y);
                ctx.lineTo(e.x, e.y);
                ctx.stroke();

                const angle = Math.atan2(e.y - s.y, e.x - s.x);
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(e.x, e.y);
                ctx.lineTo(e.x - 10 * Math.cos(angle - Math.PI/6), e.y - 10 * Math.sin(angle - Math.PI/6));
                ctx.lineTo(e.x - 10 * Math.cos(angle + Math.PI/6), e.y - 10 * Math.sin(angle + Math.PI/6));
                ctx.fill();
            });
        }

        function onDrop(source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus();
            requestAnalysis();
        }

        function updateStatus() {
            let s = game.turn() === 'w' ? 'Putih' : 'Hitam';
            if (game.in_checkmate()) s = 'SKAKMAT!';
            else if (game.in_draw()) s = 'REMIS';
            $('#gameStatus').text(s);
        }

        function flipBoard() { board.flip(); renderArrows(); }

        function undoMove() {
            game.undo();
            board.position(game.fen());
            updateStatus();
            requestAnalysis();
        }

        function resetGame() { 
            game.reset(); board.start(); updateStatus(); requestAnalysis(); 
        }

        $('#pvInput').on('input', function() { 
            $('#pvVal').text($(this).val() + " Lines"); 
            updateEngineSettings(); requestAnalysis(); 
        });
        
        $('#eloInput').on('change keyup', function() {
            updateEngineSettings(); requestAnalysis();
        });

        $(document).ready(function() {
            board = Chessboard('myBoard', {
                draggable: true,
                position: 'start',
                onDrop: onDrop,
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
            updateStatus();
            initStockfish();
        });
    </script>
</body>
</html>
