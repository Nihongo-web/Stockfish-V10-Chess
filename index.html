<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NihonChess V1 - Professional Engine</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #f8fafc; --bg-card: #ffffff;
            --accent: #6366f1; --text-primary: #0f172a;
            --text-secondary: #64748b; --board-border: #e2e8f0;
            --white-sq: #f0d9b5; --black-sq: #b58863;
        }

        body.dark {
            --bg-main: #020617; --bg-card: #0f172a;
            --accent: #818cf8; --text-primary: #f8fafc;
            --text-secondary: #94a3b8; --board-border: #1e293b;
            --white-sq: #475569; --black-sq: #1e293b;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.3s ease;
            overscroll-behavior-y: contain;
        }

        .board-container {
            position: relative; width: 100%; max-width: 480px; aspect-ratio: 1/1;
            border: 10px solid var(--board-border); border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2); touch-action: none;
        }

        .white-1e1d7 { background-color: var(--white-sq) !important; }
        .black-3c85d { background-color: var(--black-sq) !important; }
        #drawingCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 40; }

        .tag-mate { background: #f43f5e; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 800; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        @media (min-width: 1024px) {
            .main-content { display: grid; grid-template-columns: 1fr 420px; gap: 3rem; align-items: start; }
        }
    </style>
</head>
<body class="dark p-4 md:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter text-indigo-500">NIHON<span class="text-[var(--text-primary)]">CHESS</span> <span class="text-xs bg-indigo-500 text-white px-2 py-1 rounded ml-2 not-italic">V1</span></h1>
                <p class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest mt-1">Full Integrity Engine</p>
            </div>
            <button onclick="toggleTheme()" class="w-12 h-12 rounded-xl bg-indigo-500/10 border border-indigo-500/20 flex items-center justify-center text-xl">üåì</button>
        </header>

        <main class="main-content">
            <div class="flex flex-col items-center">
                <div class="board-container" id="boardParent">
                    <div id="myBoard" style="width: 100%"></div>
                    <canvas id="drawingCanvas"></canvas>
                </div>
                
                <div class="w-full max-w-[480px] mt-8">
                    <div class="flex justify-between text-[11px] font-black uppercase mb-2">
                        <span class="text-[var(--text-secondary)]">Live Analysis</span>
                        <span id="scoreVal" class="text-indigo-400 font-mono text-sm">0.00</span>
                    </div>
                    <div class="h-3 w-full bg-slate-800/30 rounded-full overflow-hidden border border-slate-700/20">
                        <div id="evalProgress" class="h-full bg-indigo-500 transition-all duration-500" style="width: 50%"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-6 mt-8 lg:mt-0">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="flipBoard()" class="bg-indigo-600 hover:bg-indigo-500 text-white py-4 rounded-xl text-[10px] font-bold uppercase transition-all">üîÑ Flip</button>
                    <button onclick="undoMove()" class="bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl text-[10px] font-bold uppercase transition-all">‚¨ÖÔ∏è Undo</button>
                </div>

                <div class="bg-[var(--bg-card)] p-6 rounded-[2rem] border border-black/5 shadow-xl space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[9px] font-black text-slate-500 uppercase block mb-1">ELO Strength</label>
                            <input type="number" id="eloInput" value="3000" class="w-full p-2 rounded-lg bg-slate-800/5 border border-slate-700/10 text-center text-xs font-bold outline-none">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-500 uppercase block mb-1">Multi-PV (<span id="pvDisplay">1</span>)</label>
                            <input type="range" id="pvInput" min="1" max="4" value="1" class="w-full accent-indigo-500">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[9px] font-black text-slate-500 uppercase">PGN History</label>
                            <button onclick="copyPGN()" class="text-[9px] font-bold text-indigo-500 uppercase">Copy</button>
                        </div>
                        <div id="pgnLog" class="h-40 bg-slate-800/5 rounded-xl p-3 overflow-y-auto text-[11px] font-mono leading-relaxed text-[var(--text-secondary)]">
                            Ready...
                        </div>
                    </div>
                </div>

                <button onclick="resetGame()" class="w-full py-3 rounded-xl text-[10px] font-black text-red-500 border border-red-500/20 hover:bg-red-500/5 uppercase">Reset Full Game</button>
            </div>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        const CHESS_CONFIG = {
            engine: { depth: 13, defaultPv: 1, maxPv: 4, defaultElo: 3000 },
            visuals: {
                bestMoveColor: "rgba(99, 102, 241, 0.85)",
                altMoveColor: "rgba(148, 163, 184, 0.4)",
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            }
        };

        let board = null, game = new Chess(), stockfish = null, currentMoves = [], lastEval = 0;

        function initEngine() {
            const engineUrl = "https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js";
            const blobUrl = URL.createObjectURL(new Blob([`importScripts("${engineUrl}");`], {type: 'application/javascript'}));
            stockfish = new Worker(blobUrl);
            stockfish.onmessage = (e) => handleEngineMessage(e.data);
            stockfish.postMessage("uci");
            updateEngineOptions();
            analyze();
        }

        function handleEngineMessage(line) {
            // PV Parsing
            if (line.includes('depth') && line.includes('multipv')) {
                const pvMatch = line.match(/multipv (\d+)/);
                const moveMatch = line.match(/pv ([a-h][1-8][a-h][1-8])/);
                if (pvMatch && moveMatch) {
                    const idx = parseInt(pvMatch[1]) - 1;
                    currentMoves[idx] = { move: moveMatch[1] };
                    drawArrows();
                }
            }
            
            // Mate Detection Logic
            if (line.includes('score mate')) {
                const mateMatch = line.match(/score mate (-?\d+)/);
                if (mateMatch) {
                    const steps = mateMatch[1];
                    $('#scoreVal').html(`<span class="tag-mate">MATE IN ${Math.abs(steps)}</span>`);
                    updateEvalBar(steps > 0 ? 100 : -100);
                }
            } else if (line.includes('score cp')) {
                let cp = parseInt(line.match(/score cp (-?\d+)/)[1]);
                let score = (cp / 100).toFixed(2);
                if (game.turn() === 'b') score = (-score).toFixed(2);
                $('#scoreVal').text((score > 0 ? '+' : '') + score);
                updateEvalBar(score);
                
                const history = game.history({verbose: true});
                if (history.length > 0) {
                    const lastMove = history[history.length - 1];
                    if (!lastMove.comment) classifyMove(parseFloat(score), lastMove);
                }
            }
        }

        function drawArrows() {
            const canvas = document.getElementById('drawingCanvas');
            const boardEl = $('#myBoard');
            if (boardEl.width() === 0) return;
            canvas.width = boardEl.width(); canvas.height = boardEl.height();
            const ctx = canvas.getContext('2d'), sq = canvas.width / 8;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            currentMoves.forEach((m, i) => {
                if (!m) return;
                const pos = (s) => {
                    let c = s.charCodeAt(0)-97, r = 8-parseInt(s[1]);
                    if (board.orientation()==='black') { c=7-c; r=7-r; }
                    return { x: (c*sq)+sq/2, y: (r*sq)+sq/2 };
                };
                const s = pos(m.move.substring(0,2)), e = pos(m.move.substring(2,4));
                const isBest = i === 0;
                const alpha = isBest ? 0.85 : Math.max(0.1, 0.4 / (i + 1));
                
                ctx.save();
                ctx.strokeStyle = isBest ? CHESS_CONFIG.visuals.bestMoveColor : `rgba(148, 163, 184, ${alpha})`;
                ctx.fillStyle = ctx.strokeStyle;
                ctx.lineWidth = isBest ? 8 : 4;
                ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(e.x, e.y); ctx.stroke();
                const angle = Math.atan2(e.y - s.y, e.x - s.x);
                ctx.translate(e.x, e.y); ctx.rotate(angle);
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-15, -8); ctx.lineTo(-15, 8); ctx.closePath();
                ctx.fill(); ctx.restore();
            });
        }

        function classifyMove(currentScore, lastMove) {
            const diff = (currentScore - lastEval) * (game.turn() === 'w' ? -1 : 1);
            if (diff > 1.2) lastMove.comment = `<span class="tag-mate" style="background:#eab308">!! BRILLIANT</span>`;
            else if (diff < -1.5) lastMove.comment = `<span class="tag-mate" style="background:#ef4444">?? BLUNDER</span>`;
            lastEval = currentScore;
            updatePGN();
        }

        function updatePGN() {
            let html = '';
            game.history({verbose: true}).forEach((m, i) => {
                if (i % 2 === 0) html += `<b>${(i/2)+1}.</b> `;
                html += `<span>${m.san}</span>${m.comment || ''} `;
            });
            if (game.in_checkmate()) html += ` <span class="tag-mate"># CHECKMATE</span>`;
            $('#pgnLog').html(html || "Ready...");
            const log = document.getElementById('pgnLog');
            log.scrollTop = log.scrollHeight;
        }

        function copyPGN() {
            const pgn = game.pgn();
            if (!pgn || pgn === "") {
                alert("Belum ada langkah untuk disalin!");
                return;
            }
            navigator.clipboard.writeText(pgn).then(() => {
                alert("PGN berhasil disalin ke clipboard!");
            }).catch(err => {
                console.error('Gagal menyalin: ', err);
            });
        }

        function updateEngineOptions() {
            stockfish.postMessage(`setoption name Skill Level value ${Math.floor($('#eloInput').val() / 150)}`);
            stockfish.postMessage(`setoption name MultiPV value ${$('#pvInput').val()}`);
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            
            currentMoves = [];
            updatePGN();
            analyze();
        }

        function updateEvalBar(val) {
            let p = Math.min(100, Math.max(0, (parseFloat(val) + 5) * 10));
            $('#evalProgress').css('width', p + '%');
        }

        function analyze() {
            stockfish.postMessage("stop");
            stockfish.postMessage("position fen " + game.fen());
            stockfish.postMessage(`go depth ${CHESS_CONFIG.engine.depth}`);
        }

        function toggleTheme() { $('body').toggleClass('dark'); board.resize(); setTimeout(drawArrows, 200); }
        function flipBoard() { board.flip(); setTimeout(drawArrows, 200); }
        function undoMove() { game.undo(); board.position(game.fen()); currentMoves = []; analyze(); updatePGN(); }
        function resetGame() { game.reset(); board.start(); currentMoves = []; lastEval = 0; analyze(); updatePGN(); }

        $(document).ready(() => {
            board = Chessboard('myBoard', { 
                draggable: true, position: 'start', 
                onDrop: onDrop,
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: CHESS_CONFIG.visuals.pieceTheme
            });
            initEngine();
            $('#pvInput').on('input', function() { $('#pvDisplay').text($(this).val()); updateEngineOptions(); analyze(); });
            $('#eloInput').on('change', () => { updateEngineOptions(); analyze(); });
            window.onresize = () => { board.resize(); drawArrows(); };
            document.getElementById('boardParent').addEventListener('touchmove', e => e.preventDefault(), { passive: false });
        });
    </script>
</body>
</html>
